import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import os

# í°íŠ¸ ê²½ë¡œ (ì‹œìŠ¤í…œì— NanumGothicì´ ì—†ìœ¼ë©´ ì„¤ì¹˜ í•„ìš”)
font_path = "NanumGothic.ttf"
if os.path.exists(font_path):
    try:
        fm.fontManager.addfont(font_path)
        plt.rc('font', family='NanumGothic')
        plt.rcParams['axes.unicode_minus'] = False
    except Exception as e:
        st.warning(f"âš ï¸ í°íŠ¸ ì ìš© ì‹¤íŒ¨: {e}. ê¸°ë³¸ í°íŠ¸ë¡œ í‘œì‹œë©ë‹ˆë‹¤.")
else:
    st.warning("âš ï¸ 'NanumGothic.ttf' í°íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í°íŠ¸ë¡œ í‘œì‹œë©ë‹ˆë‹¤.")

st.title("ğŸŒŒ ì™¸ê³„í–‰ì„± ë¯¸ì„¸ ì¤‘ë ¥ë Œì¦ˆ ì‹œë®¬ë ˆì´ì…˜")

st.markdown("""
ë©€ë¦¬ ìˆëŠ” ë³„ë¹›ì´ ìš°ë¦¬ ì‹œì„ ì— ë†“ì¸ ë‹¤ë¥¸ ë³„ê³¼ ê·¸ ì£¼ìœ„ë¥¼ ë„ëŠ” í–‰ì„±ì— ì˜í•´
ì ì‹œ ë°ì•„ì§€ëŠ” **ë¯¸ì„¸ ì¤‘ë ¥ë Œì¦ˆ** í˜„ìƒì„ ì‹œë®¬ë ˆì´ì…˜í•´ ë³´ì„¸ìš”!
**ì•„ë˜ ì‹œê°„ ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì—¬ ê° ì‹œì ì—ì„œ ë³„ê³¼ í–‰ì„±, ê´‘ì›ì˜ ìœ„ì¹˜ê°€ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”.**
""")

st.sidebar.header("ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •")

# --- ì„¤ì • ë³€ìˆ˜ ---
# ë Œì¦ˆ ë³„ì˜ ì§ˆëŸ‰ (ìƒëŒ€ì  ê°’)
star_mass = st.sidebar.slider("ë Œì¦ˆ ë³„ì˜ ì§ˆëŸ‰ (ìƒëŒ€ê°’)", 1.0, 10.0, 5.0, 0.1)

# í–‰ì„±ì˜ ì§ˆëŸ‰ (ë Œì¦ˆ ë³„ ì§ˆëŸ‰ì— ëŒ€í•œ ë¹„ìœ¨)
planet_mass_ratio = st.sidebar.slider("í–‰ì„±ì˜ ì§ˆëŸ‰ (ë Œì¦ˆ ë³„ ì§ˆëŸ‰ì— ëŒ€í•œ ë¹„ìœ¨)", 0.01, 1.0, 0.1, 0.01)
planet_mass = star_mass * planet_mass_ratio

# í–‰ì„±ì˜ ê¶¤ë„ ë°˜ì§€ë¦„ (ë Œì¦ˆ ë³„ ì£¼ìœ„)
orbit_radius = st.sidebar.slider("í–‰ì„± ê¶¤ë„ ë°˜ì§€ë¦„ (AU)", 0.1, 2.0, 0.5, 0.05)

# ê´‘ì›(ë°°ê²½ ë³„)ì˜ ìµœì†Œ ì ‘ê·¼ ê±°ë¦¬ (ë Œì¦ˆë¡œë¶€í„°)
min_approach_distance = st.sidebar.slider("ê´‘ì›ì˜ ìµœì†Œ ì ‘ê·¼ ê±°ë¦¬ (ë Œì¦ˆ ì¤‘ì‹¬ìœ¼ë¡œë¶€í„°)", 0.1, 2.0, 0.5, 0.1)

# ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„ ë²”ìœ„ (ìƒëŒ€ì )
time_range = st.sidebar.slider("ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„ ë²”ìœ„ (ìƒëŒ€ì )", 5, 50, 20)

# ì‹œê°„ ë‹¨ê³„ ìˆ˜
num_time_steps = st.sidebar.slider("ì‹œë®¬ë ˆì´ì…˜ ì‹œê°„ ë‹¨ê³„ ìˆ˜", 50, 500, 200)

st.sidebar.markdown("---")
st.sidebar.info("""
**ì„¤ëª…:**
- **ë Œì¦ˆ ë³„:** ìš°ë¦¬ ì‹œì„ ì— ë†“ì—¬ ê´‘ì› ë³„ë¹›ì„ íœ˜ê²Œ í•˜ëŠ” ì£¼ëœ ì§ˆëŸ‰ì²´.
- **í–‰ì„±:** ë Œì¦ˆ ë³„ ì£¼ìœ„ë¥¼ ê³µì „í•˜ë©° ë°ê¸° ë³€í™”ì— ë¯¸ì„¸í•œ ì´ìƒ í˜„ìƒ(anomaly)ì„ ë§Œë“­ë‹ˆë‹¤.
- **ê´‘ì›ì˜ ìµœì†Œ ì ‘ê·¼ ê±°ë¦¬:** ê´‘ì›ì´ ë Œì¦ˆì— ê°€ì¥ ê°€ê¹Œì´ ë‹¤ê°€ì˜¤ëŠ” ê°€ìƒì˜ ê±°ë¦¬ì…ë‹ˆë‹¤.
""")

# --- ì¤‘ë ¥ë Œì¦ˆ ë°ê¸° ê³„ì‚° í•¨ìˆ˜ ---
# (ë§¤ìš° ë‹¨ìˆœí™”ëœ ëª¨ë¸. ì‹¤ì œëŠ” ë³µì¡í•œ ë§ˆì´í¬ë¡œë Œì§• ë°©ì •ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.)
def calculate_magnification(source_position_relative, lens_positions, lens_masses, scale_factor=0.1):
    """
    ì£¼ì–´ì§„ ê´‘ì› ìœ„ì¹˜ì™€ ë Œì¦ˆ ì •ë³´ì— ë”°ë¥¸ ëŒ€ëµì ì¸ ë°ê¸° ì¦í­ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    (ì´ê²ƒì€ ì‹¤ì œ ë§ˆì´í¬ë¡œë Œë”© ì¦í­ ê³„ì‚°ê³¼ ë§¤ìš° ë‹¤ë¦„. ê°œë…ì  ì‹œê°í™”ë¥¼ ìœ„í•¨.)

    Args:
        source_position_relative (float or np.array): ë Œì¦ˆ ì¤‘ì‹¬ìœ¼ë¡œë¶€í„° ê´‘ì›ì˜ ìƒëŒ€ì  ìœ„ì¹˜.
        lens_positions (list of float or np.array): ê° ë Œì¦ˆì˜ ìƒëŒ€ì  X, Y ìœ„ì¹˜.
        lens_masses (list of float): ê° ë Œì¦ˆì˜ ì§ˆëŸ‰.
        scale_factor (float): ì¦í­ íš¨ê³¼ì˜ ìŠ¤ì¼€ì¼ ì¡°ì ˆ.

    Returns:
        float or np.array: ë°ê¸° ì¦í­ ê°’.
    """
    total_def
